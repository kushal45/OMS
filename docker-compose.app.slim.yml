services:
  app-base:
    image: oms-app-base:latest
    build:
      context: .
      dockerfile: Dockerfile
    command: echo "Base image built successfully"
    profiles:
      - build-only

  gateway:
    image: oms-app-base:latest
    depends_on:
      auth:
        condition: service_healthy
      order:
        condition: service_healthy
    ports:
      - "3000:3000"
      - "9229:9229"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://gateway:3000/api-gateway/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    environment:
      - NODE_ENV=production # Changed to production
      - PORT=3000
      - SERVICE_NAME=gateway
      - REDIS_CLIENT_TYPE=STANDALONE
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      # Removed Kafka and Elasticsearch related environment variables
    command: node dist/apps/api-gateway/src/main.js # Run compiled code directly
    networks:
      - oms-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M # Reduced memory limit
          cpus: '0.1' # Reduced CPU limit
        reservations:
          memory: 128M
          cpus: '0.05'

  auth:
    image: oms-app-base:latest
    ports:
      - "3001:3001"
      - "9230:9229"
    environment:
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - DATABASE_HOST=host.docker.internal
      - DATABASE_PORT=5433
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=oms
      - REDIS_CLIENT_TYPE=STANDALONE
      - NODE_ENV=production # Changed to production
      # Removed Kafka and Elasticsearch related environment variables
    command: node dist/apps/auth/src/main.js # Run compiled code directly
    networks:
      - oms-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://auth:3001/auth/health || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M # Reduced memory limit
          cpus: '0.1' # Reduced CPU limit
        reservations:
          memory: 128M
          cpus: '0.05'

  order:
    image: oms-app-base:latest
    ports:
      - "3002:3002"
      - "9231:9229"
    environment:
        - NODE_ENV=production # Changed to production
        - DATABASE_HOST=host.docker.internal
        - DATABASE_PORT=5433
        - DATABASE_USER=postgres
        - DATABASE_PASSWORD=postgres
        - DATABASE_NAME=oms
        # Removed KAFKA_BROKERS
        - REDIS_CLIENT_TYPE=STANDALONE
        - REDIS_HOST=host.docker.internal
        - REDIS_PORT=6379
    command: node dist/apps/order/src/main.js # Run compiled code directly
    networks:
      - oms-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://order:3002/order/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M # Reduced memory limit
          cpus: '0.1' # Reduced CPU limit
        reservations:
          memory: 128M
          cpus: '0.05'

  inventory:
    image: oms-app-base:latest
    ports:
      - "3003:3003"
      - "5002:5002"
      - "9232:9229"
    environment:
      # Removed KAFKA_BROKERS
      - DATABASE_HOST=host.docker.internal
      - DATABASE_PORT=5433
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=oms
      - REDIS_CLIENT_TYPE=STANDALONE
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - NODE_ENV=production # Changed to production
    command: node dist/apps/inventory/src/main.js # Run compiled code directly
    networks:
      - oms-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://inventory:3003/inventories/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M # Reduced memory limit
          cpus: '0.1' # Reduced CPU limit
        reservations:
          memory: 128M
          cpus: '0.05'

  product:
    image: oms-app-base:latest
    ports:
      - "3004:3004"
      - "9233:9229"
    environment:
      - NODE_ENV=production # Changed to production
      - DATABASE_HOST=host.docker.internal
      - DATABASE_PORT=5433
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=oms
      - PORT=3004
      # Removed KAFKA_BROKERS
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - REDIS_CLIENT_TYPE=STANDALONE
    command: node dist/apps/product/src/main.js # Run compiled code directly
    networks:
      - oms-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://product:3004/products/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M # Reduced memory limit
          cpus: '0.1' # Reduced CPU limit
        reservations:
          memory: 128M
          cpus: '0.05'

  cart:
    image: oms-app-base:latest
    ports:
      - "3005:3005"
      - "9234:9229"
      - "5005:5005"
    environment:
      - NODE_ENV=production # Changed to production
      - DATABASE_HOST=host.docker.internal
      - DATABASE_PORT=5433
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=oms
      - PORT=3005
      - SERVICE_NAME=cart
      # Removed KAFKA_BROKERS
      - INVENTORY_RESERVE_TOPIC=reserveInventory
      - INVENTORY_RELEASE_TOPIC=releaseInventory
      - REDIS_CLIENT_TYPE=STANDALONE
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
    command: node dist/apps/cart/src/main.js # Run compiled code directly
    networks:
      - oms-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://cart:3005/cart/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M # Reduced memory limit
          cpus: '0.1' # Reduced CPU limit
        reservations:
          memory: 128M
          cpus: '0.05'

networks:
  oms-network:
    driver: bridge
    external: true
